<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Run a benchmark from the terminal • agrometeoR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Run a benchmark from the terminal">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">agrometeoR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Development_roadmap.html">Development Roadmap</a>
    </li>
    <li>
      <a href="../articles/Partners.html">Partners</a>
    </li>
    <li>
      <a href="../articles/Presentation_agromet_project.html">Presentation of the Agromet Project</a>
    </li>
    <li>
      <a href="../articles/Spatialization_method_approach.html">A methodological approach to assess the best weather spatialization technique</a>
    </li>
    <li>
      <a href="../articles/benchmark_from_terminal.html">Run a benchmark from the terminal</a>
    </li>
    <li>
      <a href="../articles/gstat_integration_mlr.html">Integration of gstat into mlr</a>
    </li>
    <li>
      <a href="../articles/interpolation_grid_creation.html">Creation of the interpolation Grid</a>
    </li>
    <li>
      <a href="../articles/weather_spatialisation_review.html">Agromet : Weather Spatialization Review and Benchmark</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../tutorials/presentation.html">FOSS4GBXL2018</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/pokyah/agrometeoR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><script src="benchmark_from_terminal_files/htmlwidgets-1.3/htmlwidgets.js"></script><script src="benchmark_from_terminal_files/jquery-1.12.4/jquery.min.js"></script><link href="benchmark_from_terminal_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="benchmark_from_terminal_files/datatables-binding-0.5/datatables.js"></script><link href="benchmark_from_terminal_files/dt-core-1.10.16/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="benchmark_from_terminal_files/dt-core-1.10.16/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="benchmark_from_terminal_files/dt-core-1.10.16/js/jquery.dataTables.min.js"></script><link href="benchmark_from_terminal_files/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet">
<script src="benchmark_from_terminal_files/crosstalk-1.0.0/js/crosstalk.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Run a benchmark from the terminal</h1>
            
            <h4 class="date">04/30/2019</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/pokyah/agrometeoR/blob/master/vignettes/benchmark_from_terminal.Rmd"><code>vignettes/benchmark_from_terminal.Rmd</code></a></small>
      <div class="hidden name"><code>benchmark_from_terminal.Rmd</code></div>

    </div>

    
    
<div id="objectif" class="section level1">
<h1 class="hasAnchor">
<a href="#objectif" class="anchor"></a>Objectif</h1>
<p>A partir d’un extrait en hourly de la database historique (2 ans), réaliser un benchrmark de plusieurs explorative constructions pour TSA, tant en daily qu’en hourly. Les données daily devront être calculées à partir des hourly.</p>
<p>Afin de réduire drastiquement les temps de calcul et de réaliser des visualisations graphiques interactives légères, il conviendra de ne pas réaliser les benchmarks d’EC sur l’ensemble des 2 ans de données mais sur plusieurs (5 par exemple) sous-échantillons tirés aléatoirements (suggestion faite par P. Bogaerts lors du CA d’avril 2019).</p>
</div>
<div id="initialisation-du-projet" class="section level1">
<h1 class="hasAnchor">
<a href="#initialisation-du-projet" class="anchor"></a>Initialisation du projet</h1>
<p>Il convient de créer un folder dans lequel nous sauvegarderons les fichiers nécessaires à la conduction d’un benchmark. Ce folder servira de working directory. A noter qu’en travaillant depuis RStudio, le working directory se place automatiquement à la racine du folder considéré comme folder du projet. Dans le contexte de cet exemple nous le créerons au chemin suivant : <code>~/Rprojects/project_bmr_from_bash</code>.</p>
<p>Un serveur RStudio dédié a été configuré et est disponible à l’adresse <code>http://agromet.cra.wallonie.be:8787</code></p>
</div>
<div id="creation-des-jeux-de-donnnees-" class="section level1">
<h1 class="hasAnchor">
<a href="#creation-des-jeux-de-donnnees-" class="anchor"></a>Création des jeux de donnnées.</h1>
<div id="charger-lextract-hourly-de-la-database" class="section level2">
<h2 class="hasAnchor">
<a href="#charger-lextract-hourly-de-la-database" class="anchor"></a>Charger l’extract hourly de la database</h2>
<p>Ici nous récupérons un extract de la db au format json que nous chargeons dans un object R que nous appelerons <code>dataset</code>. Cet extract au format <code>.json</code> a été créer par JP et mis à disposition via FTP.</p>
<p>Le script suivant permet de récupérer les data via le FTP depuis R :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get data from FTP and save it in the current WD - should work if the port is open</span>
threadr<span class="op">::</span><span class="kw">download_ftp_file</span>(
  <span class="dt">file_remote =</span> <span class="st">"ftp://178.32.44.217/spCleandataSensorstsaForallFm2016-01-01To2017-12-31.json"</span>,
  <span class="dt">file_output =</span> <span class="st">"./data-raw/spCleandataSensorstsaForallFm2016-01-01To2017-12-31.json"</span>,
  <span class="dt">credentials =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"agromet:"</span>,
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getenv">Sys.getenv</a></span>(<span class="st">"FTP_PASSWORD"</span>)),
  <span class="dt">curl =</span> <span class="ot">FALSE</span>, <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">progress =</span> <span class="st">"none"</span>)</code></pre></div>
<p>Ici supposons que le fichier <code>.json</code> a déjà été récupéré. Injectons-le maintenant dans une variable <code>dataset_hourly</code> grâce à notre fonction <code><a href="https://www.rdocumentation.org/packages/agrometeoR/topics/makeDataset">agrometeoR::makeDataset()</a></code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dataset_hourly =<span class="st"> </span><span class="kw">makeDataset</span>(<span class="dt">json =</span> <span class="st">"../data-raw/extdata/AGROMET/spCleandataSensorstsaForallFm2016-01-01To2017-12-31.json"</span>, <span class="dt">sensors =</span> <span class="st">"tsa"</span> )
dataset_hourly =<span class="st"> </span>dataset_hourly<span class="op">$</span>output<span class="op">$</span>value</code></pre></div>
<p>A noter qu’il est également possible de réaliser un appel API <code>spcleandata</code> pour récupérer ces data. Cependant vu la taille du fichier à récupérer, cela résulterait en un timeout.</p>
<p>Visualisons un extrait d’un jeu de donnée d’une heure :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/DT/topics/datatable">datatable</a></span>(dataset_hourly[[<span class="dv">2</span>]])</code></pre></div>
<div id="htmlwidget-acdcd2cea1a635f46f5a" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-acdcd2cea1a635f46f5a">{"x":{"filter":"none","data":[["2","17523","35044","52565","70086","87607","105128","122649","140170","157691","175212","192733","210254","227775","245296","262817","280338","297859","315380","332901","350422","367943","385464","402985","420506","438027","455548","473069","490590","508111","525632","543153","560674","578195","595716","613237","630758","648279","665800","683321","700842","718363","735884","753405"],["2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z","2015-12-31T23:00:00Z"],[33,10,40,24,36,4,13,32,25,23,38,34,14,19,15,61,17,42,26,1,18,9,39,29,7,35,27,37,1009,1003,1012,1002,1004,1011,1007,1015,1001,1008,1006,1000,1014,1010,1013,1005],[6.3,3.1,6.9,3.6,7.2,3.8,6,6.1,1.8,0.7,7.2,7.2,6,6.9,5.6,5.2,6.2,6.2,5.8,2.8,6.4,1.8,6.3,null,3.8,5.5,6.5,7.3,6.4,6.4,6.2,2.3,7.1,7.1,6.2,2.2,6.5,5.3,6.5,5.5,2.1,3.5,3.7,7],[729689.186232954,734687.929509015,658415.101041165,756742.822500184,627307.661070376,714221.209144658,641664.774797854,705538.981444004,783160.145063778,772236.165811055,574629.058020142,640641.2284459,737727.264778507,678027.226189239,683923.206578923,713314.373606281,712454.191609501,751432.178937187,687345.744040475,721240.184391761,669292.934672129,753130.611776411,679485.472308161,737505.849377553,750500.668626812,722969.231282202,666459.252552218,647940.949348427,677965.925108566,561947.886825626,726465.421886178,738189.82622835,612048.928118617,726101.073875598,666169.149580912,778678.216185889,672824.981075056,670073.832292241,656058.249475909,713345.681462783,770904.554551938,723891.718683316,759876.017461924,649233.118838048],[653082.367312686,580969.576613894,641458.222311023,616701.10045012,636375.292340349,543453.775467364,588814.572323289,635009.757849171,627630.802845596,611877.550607324,641464.793156667,636931.490722412,621625.053035861,626899.296759005,609727.175874467,598442.549766796,595357.711935966,635301.52304187,638365.311350664,568849.614202561,650971.028015921,581716.936230862,656365.759641032,525914.293584876,550825.572519077,628081.869385831,635438.329307189,609042.529115887,659687.711793583,677359.994620503,649386.198126525,535101.990977799,639719.319977717,678973.35995613,587164.006571929,631831.531694833,641419.442621129,602477.163650627,627578.522246851,598451.826531465,634737.222400075,580713.835939818,631403.440081561,665155.768221807],[160.30742628053,390.309470906876,123.673744485628,415.850883728445,95.4065320929548,343.262113452198,259.474801238954,170.11553676668,623.602330192649,538.472515251095,49.0728353792276,117.126398205931,238.256344351755,93.708054231619,219.974695428517,289.133356310043,243.037079128113,286.311629102436,173.655601233621,474.945369085699,133.827267005294,496.688240385978,138.220813581026,317.319254249168,348.391795103584,273.799691609328,147.213489415358,156.315703056096,111.358900493969,23.7993757913728,169.067539772099,318.599993452161,56.6184361607534,37.2035515492856,218.336035689858,561.043571026899,158.522674213813,292.03130227237,180.166378879808,288.894685364012,670.070163790368,531.770348640693,465.725150789949,101.900728715773]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>mtime<\/th>\n      <th>sid<\/th>\n      <th>tsa<\/th>\n      <th>x<\/th>\n      <th>y<\/th>\n      <th>elevation<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="creation-du-jeu-de-donnees-daily" class="section level2">
<h2 class="hasAnchor">
<a href="#creation-du-jeu-de-donnees-daily" class="anchor"></a>Création du jeu de données daily</h2>
<p>Celui-ci doit évidemment être créé avant de réaliser l’échantillonage des subsets (sinon nous ne disposons pas de série de 24h continues nécessaires au calcul des informations journalières). Le script ci-dessous montre comment calculer les données daily sur base des hourly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## create the daily datasets and tasks for Pameseb and Pameseb + IRm
summarize_by_day =<span class="st"> </span><span class="cf">function</span>(l){
  
  split_tibble =<span class="st"> </span><span class="cf">function</span>(tibble, <span class="dt">column =</span> <span class="st">'col'</span>) {
  tibble <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/split">split</a></span>(., .[,column]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(., <span class="cf">function</span>(x) x[,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sets">setdiff</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(x),column)])
  }
  
  dataset =<span class="st"> </span>l <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map_df</a></span>(.,c, <span class="dt">.id =</span> <span class="st">"datetime"</span>)
  a =<span class="st"> </span>dataset <span class="op">%&gt;%</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_at</a></span>(<span class="st">"datetime"</span>, <span class="cf">function</span>(x){
      x =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/substr">substr</a></span>(x, <span class="dt">start =</span> <span class="dv">1</span>, <span class="dt">stop =</span> <span class="dv">8</span>)
    })

  b =<span class="st"> </span>a <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(datetime, sid) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">summarise</span>(
      <span class="dt">tsa_min =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(tsa, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
      <span class="dt">tsa_max =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(tsa, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>),
      <span class="dt">tsa_mean =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(tsa, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))

  b =<span class="st"> </span>b <span class="op">%&gt;%</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="st">"mtime"</span> =<span class="st"> "datetime"</span>)

  b =<span class="st"> </span>b <span class="op">%&gt;%</span>
<span class="st">    </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(stations.df, <span class="kw">one_of</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"elevation"</span>, <span class="st">"sid"</span>))), <span class="dt">by =</span> <span class="st">"sid"</span>)

  c =<span class="st"> </span>b <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">split_tibble</span>(<span class="st">"mtime"</span>)

  d =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(c), <span class="cf">function</span>(x){
    mtime =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(c)[x]
    mtime =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep.int</a></span>(mtime, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/nrow">nrow</a></span>(c[[x]]))
    df =<span class="st"> </span>c[[x]] <span class="op">%&gt;%</span>
<span class="st">      </span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">mtime =</span> mtime)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(df)
  })

  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(d) =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(c)
  d =<span class="st"> </span>d <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(as.data.frame)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(d)
}

dataset_daily =<span class="st">  </span>dataset_hourly <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize_by_day</span>()</code></pre></div>
<p>Visualisons un extrait des data aggrégées en daily :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/DT/topics/datatable">datatable</a></span>(dataset_daily[[<span class="dv">2</span>]])</code></pre></div>
<div id="htmlwidget-85533c3cbd769cccabef" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-85533c3cbd769cccabef">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41","42","43","44"],[1,4,7,9,10,13,14,15,17,18,19,23,24,25,26,27,29,32,33,34,35,36,37,38,39,40,42,61,1000,1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1011,1012,1013,1014,1015],[3,3.6,3.6,2.7,3.6,5.3,5.4,5.6,6,5.5,6.2,2.3,3.6,1.9,5.6,5.5,null,5.6,5.7,6.2,5.8,6.4,6.7,6.5,5.1,5.7,5.9,4.7,4.9,5.5,4.2,6.6,6.5,5.6,5.3,5.6,4.5,5.4,2.4,5.6,5.7,3.3,1.8,2.7],[6.9,8.2,8.2,5.9,7.8,10,9,9.9,10,10.3,11,5.1,6.5,4.5,10,10.6,null,10.1,9.3,10.6,9.5,10.1,11.5,10.3,9.9,10.4,8.9,9,9.1,10.3,8.3,10.5,10.6,11,10,10.2,8.8,10.3,6.2,10.2,9.1,6.1,4.4,5.3],[4.91666666666667,5.93333333333333,5.93333333333333,4.26666666666667,5.4375,7.3375,7.1625,7.68333333333333,7.69583333333333,7.56666666666667,8.3875,3.55833333333333,4.85,3.225,7.575,7.70833333333333,null,7.6125,7.52916666666667,8.175,7.51666666666667,7.9625,8.625,8.125,7.31666666666667,7.86666666666667,7.19166666666667,6.72916666666667,6.95416666666667,7.675,6.10416666666667,8.37916666666667,8.3125,7.8625,7.5625,7.58333333333333,6.66666666666667,7.77916666666667,4.29166666666667,7.92083333333333,7.4125,4.45833333333333,3.06666666666667,3.93333333333333],[721240.184391761,714221.209144658,750500.668626812,753130.611776411,734687.929509015,641664.774797854,737727.264778507,683923.206578923,712454.191609501,669292.934672129,678027.226189239,772236.165811055,756742.822500184,783160.145063778,687345.744040475,666459.252552218,737505.849377553,705538.981444004,729689.186232954,640641.2284459,722969.231282202,627307.661070376,647940.949348427,574629.058020142,679485.472308161,658415.101041165,751432.178937187,713314.373606281,713345.681462783,672824.981075056,738189.82622835,561947.886825626,612048.928118617,649233.118838048,656058.249475909,666169.149580912,670073.832292241,677965.925108566,723891.718683316,726101.073875598,726465.421886178,759876.017461924,770904.554551938,778678.216185889],[568849.614202561,543453.775467364,550825.572519077,581716.936230862,580969.576613894,588814.572323289,621625.053035861,609727.175874467,595357.711935966,650971.028015921,626899.296759005,611877.550607324,616701.10045012,627630.802845596,638365.311350664,635438.329307189,525914.293584876,635009.757849171,653082.367312686,636931.490722412,628081.869385831,636375.292340349,609042.529115887,641464.793156667,656365.759641032,641458.222311023,635301.52304187,598442.549766796,598451.826531465,641419.442621129,535101.990977799,677359.994620503,639719.319977717,665155.768221807,627578.522246851,587164.006571929,602477.163650627,659687.711793583,580713.835939818,678973.35995613,649386.198126525,631403.440081561,634737.222400075,631831.531694833],[474.945369085699,343.262113452198,348.391795103584,496.688240385978,390.309470906876,259.474801238954,238.256344351755,219.974695428517,243.037079128113,133.827267005294,93.708054231619,538.472515251095,415.850883728445,623.602330192649,173.655601233621,147.213489415358,317.319254249168,170.11553676668,160.30742628053,117.126398205931,273.799691609328,95.4065320929548,156.315703056096,49.0728353792276,138.220813581026,123.673744485628,286.311629102436,289.133356310043,288.894685364012,158.522674213813,318.599993452161,23.7993757913728,56.6184361607534,101.900728715773,180.166378879808,218.336035689858,292.03130227237,111.358900493969,531.770348640693,37.2035515492856,169.067539772099,465.725150789949,670.070163790368,561.043571026899],["20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102","20160102"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>sid<\/th>\n      <th>tsa_min<\/th>\n      <th>tsa_max<\/th>\n      <th>tsa_mean<\/th>\n      <th>x<\/th>\n      <th>y<\/th>\n      <th>elevation<\/th>\n      <th>mtime<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[1,2,3,4,5,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="creation-des-sous-echantillons-aleatoires-" class="section level2">
<h2 class="hasAnchor">
<a href="#creation-des-sous-echantillons-aleatoires-" class="anchor"></a>Création des sous-échantillons aléatoires.</h2>
<p>Réaliser un benchmark sur deux ans de données horaires est très couteux en terme de puissance et temps de calcul. On choisit donc de réaliser plusieurs sous-benchmarks sur 10 % des data tirées aléatoirement. Pour réduire les temps de calcul dans le contexte de cet exemple, nous ne prendrons que 0.1 % des données dans chacun de nos 5 sous-échantillons. Pour assurer la reproductibilité des benchmarks, il est nécessaire de réaliser les tirages aléatoires en se basant sur une “seed”. Nous nous limiterons à l’exemple pour les data en hourly.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># definition of the function to create the subsamples</span>
create_subset =<span class="st"> </span><span class="cf">function</span>(seed, dataset, percentage){
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(seed)
dataset_sample =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sample">sample</a></span>(
  <span class="dt">x =</span> dataset,
  <span class="dt">size =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(percentage<span class="op">*</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(dataset)<span class="op">/</span><span class="dv">100</span>))
}

<span class="co"># creating the vector of the seeds that will be used to generate 5 subsets</span>
seeds =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">2019</span>, <span class="dv">2018</span>, <span class="dv">2017</span>, <span class="dv">2016</span>, <span class="dv">2015</span>)

<span class="co"># creating the 5 subsets of 0.1 % of the whole dataset (we should use 10 to respect 10 % but for the example we only take 0.1 %)</span>
subsets_hourly =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(seeds, create_subset, dataset_hourly, <span class="fl">0.1</span>)</code></pre></div>
<p>Visualisons le premier jeu de données horaires du premier subset</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/DT/topics/datatable">datatable</a></span>(subsets_hourly[[<span class="dv">1</span>]][[<span class="dv">1</span>]])</code></pre></div>
<div id="htmlwidget-5ca5ecf9e5a7d1ca14ef" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-5ca5ecf9e5a7d1ca14ef">{"x":{"filter":"none","data":[["13490","31011","48532","66053","83574","101095","118616","136137","153658","171179","188700","206221","223742","241263","258784","276305","293826","311347","328868","346389","363910","381431","398952","416473","433994","451515","469036","486557","504078","521599","539120","556641","574162","591683","609204","626725","644246","661767","679288","696809","714330","731851","749372","766893"],["2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z"],[33,10,40,24,36,4,13,32,25,23,38,34,14,19,15,61,17,42,26,1,18,9,39,29,7,35,27,37,1009,1003,1012,1002,1004,1011,1007,1015,1001,1008,1006,1000,1014,1010,1013,1005],[17,13.7,14.6,14.7,null,15.4,14.6,15.6,12.6,13.2,16.5,14.9,15.5,16.5,16.3,14.9,15.4,16.2,15.7,14.2,15.1,13.8,15.1,15.8,15,15,15.2,14.8,15.1,16.5,16.4,14.6,16.1,16,16.1,12.1,15,15,14.8,14.9,11.8,12.9,13.2,15.3],[729689.186232954,734687.929509015,658415.101041165,756742.822500184,627307.661070376,714221.209144658,641664.774797854,705538.981444004,783160.145063778,772236.165811055,574629.058020142,640641.2284459,737727.264778507,678027.226189239,683923.206578923,713314.373606281,712454.191609501,751432.178937187,687345.744040475,721240.184391761,669292.934672129,753130.611776411,679485.472308161,737505.849377553,750500.668626812,722969.231282202,666459.252552218,647940.949348427,677965.925108566,561947.886825626,726465.421886178,738189.82622835,612048.928118617,726101.073875598,666169.149580912,778678.216185889,672824.981075056,670073.832292241,656058.249475909,713345.681462783,770904.554551938,723891.718683316,759876.017461924,649233.118838048],[653082.367312686,580969.576613894,641458.222311023,616701.10045012,636375.292340349,543453.775467364,588814.572323289,635009.757849171,627630.802845596,611877.550607324,641464.793156667,636931.490722412,621625.053035861,626899.296759005,609727.175874467,598442.549766796,595357.711935966,635301.52304187,638365.311350664,568849.614202561,650971.028015921,581716.936230862,656365.759641032,525914.293584876,550825.572519077,628081.869385831,635438.329307189,609042.529115887,659687.711793583,677359.994620503,649386.198126525,535101.990977799,639719.319977717,678973.35995613,587164.006571929,631831.531694833,641419.442621129,602477.163650627,627578.522246851,598451.826531465,634737.222400075,580713.835939818,631403.440081561,665155.768221807],[160.30742628053,390.309470906876,123.673744485628,415.850883728445,95.4065320929548,343.262113452198,259.474801238954,170.11553676668,623.602330192649,538.472515251095,49.0728353792276,117.126398205931,238.256344351755,93.708054231619,219.974695428517,289.133356310043,243.037079128113,286.311629102436,173.655601233621,474.945369085699,133.827267005294,496.688240385978,138.220813581026,317.319254249168,348.391795103584,273.799691609328,147.213489415358,156.315703056096,111.358900493969,23.7993757913728,169.067539772099,318.599993452161,56.6184361607534,37.2035515492856,218.336035689858,561.043571026899,158.522674213813,292.03130227237,180.166378879808,288.894685364012,670.070163790368,531.770348640693,465.725150789949,101.900728715773]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>mtime<\/th>\n      <th>sid<\/th>\n      <th>tsa<\/th>\n      <th>x<\/th>\n      <th>y<\/th>\n      <th>elevation<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># in your console, you can simply use :</span>
subsets_hourly[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</code></pre></div>
<pre><code>##                      mtime  sid  tsa        x        y elevation
## 13490  2017-07-16 01:00:00   33 17.0 729689.2 653082.4 160.30743
## 31011  2017-07-16 01:00:00   10 13.7 734687.9 580969.6 390.30947
## 48532  2017-07-16 01:00:00   40 14.6 658415.1 641458.2 123.67374
## 66053  2017-07-16 01:00:00   24 14.7 756742.8 616701.1 415.85088
## 83574  2017-07-16 01:00:00   36   NA 627307.7 636375.3  95.40653
## 101095 2017-07-16 01:00:00    4 15.4 714221.2 543453.8 343.26211
## 118616 2017-07-16 01:00:00   13 14.6 641664.8 588814.6 259.47480
## 136137 2017-07-16 01:00:00   32 15.6 705539.0 635009.8 170.11554
## 153658 2017-07-16 01:00:00   25 12.6 783160.1 627630.8 623.60233
## 171179 2017-07-16 01:00:00   23 13.2 772236.2 611877.6 538.47252
## 188700 2017-07-16 01:00:00   38 16.5 574629.1 641464.8  49.07284
## 206221 2017-07-16 01:00:00   34 14.9 640641.2 636931.5 117.12640
## 223742 2017-07-16 01:00:00   14 15.5 737727.3 621625.1 238.25634
## 241263 2017-07-16 01:00:00   19 16.5 678027.2 626899.3  93.70805
## 258784 2017-07-16 01:00:00   15 16.3 683923.2 609727.2 219.97470
## 276305 2017-07-16 01:00:00   61 14.9 713314.4 598442.5 289.13336
## 293826 2017-07-16 01:00:00   17 15.4 712454.2 595357.7 243.03708
## 311347 2017-07-16 01:00:00   42 16.2 751432.2 635301.5 286.31163
## 328868 2017-07-16 01:00:00   26 15.7 687345.7 638365.3 173.65560
## 346389 2017-07-16 01:00:00    1 14.2 721240.2 568849.6 474.94537
## 363910 2017-07-16 01:00:00   18 15.1 669292.9 650971.0 133.82727
## 381431 2017-07-16 01:00:00    9 13.8 753130.6 581716.9 496.68824
## 398952 2017-07-16 01:00:00   39 15.1 679485.5 656365.8 138.22081
## 416473 2017-07-16 01:00:00   29 15.8 737505.8 525914.3 317.31925
## 433994 2017-07-16 01:00:00    7 15.0 750500.7 550825.6 348.39180
## 451515 2017-07-16 01:00:00   35 15.0 722969.2 628081.9 273.79969
## 469036 2017-07-16 01:00:00   27 15.2 666459.3 635438.3 147.21349
## 486557 2017-07-16 01:00:00   37 14.8 647940.9 609042.5 156.31570
## 504078 2017-07-16 01:00:00 1009 15.1 677965.9 659687.7 111.35890
## 521599 2017-07-16 01:00:00 1003 16.5 561947.9 677360.0  23.79938
## 539120 2017-07-16 01:00:00 1012 16.4 726465.4 649386.2 169.06754
## 556641 2017-07-16 01:00:00 1002 14.6 738189.8 535102.0 318.59999
## 574162 2017-07-16 01:00:00 1004 16.1 612048.9 639719.3  56.61844
## 591683 2017-07-16 01:00:00 1011 16.0 726101.1 678973.4  37.20355
## 609204 2017-07-16 01:00:00 1007 16.1 666169.1 587164.0 218.33604
## 626725 2017-07-16 01:00:00 1015 12.1 778678.2 631831.5 561.04357
## 644246 2017-07-16 01:00:00 1001 15.0 672825.0 641419.4 158.52267
## 661767 2017-07-16 01:00:00 1008 15.0 670073.8 602477.2 292.03130
## 679288 2017-07-16 01:00:00 1006 14.8 656058.2 627578.5 180.16638
## 696809 2017-07-16 01:00:00 1000 14.9 713345.7 598451.8 288.89469
## 714330 2017-07-16 01:00:00 1014 11.8 770904.6 634737.2 670.07016
## 731851 2017-07-16 01:00:00 1010 12.9 723891.7 580713.8 531.77035
## 749372 2017-07-16 01:00:00 1013 13.2 759876.0 631403.4 465.72515
## 766893 2017-07-16 01:00:00 1005 15.3 649233.1 665155.8 101.90073</code></pre>
</div>
<div id="creation-de-doublons-ne-contenant-que-les-data-pameseb" class="section level2">
<h2 class="hasAnchor">
<a href="#creation-de-doublons-ne-contenant-que-les-data-pameseb" class="anchor"></a>Création de doublons ne contenant que les data Pameseb</h2>
<p>Comme nous souhaitons également évaluer l’apport de l’intégration des data IRM, nous allons dédoubler chacun de nos 5 sous échantillons en passant un filtre excluant les données des stations IRM pour chacun des groupes d’enregistrements horaires.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subsets_hourly_without_IRM =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(subsets_hourly, <span class="cf">function</span>(x){ <span class="co"># here each x correspond to one of our 5 subsets</span>
  x_without_irm =<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(., <span class="op">~</span>dplyr<span class="op">::</span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(.,sid <span class="op">&lt;</span><span class="st"> </span><span class="dv">1000</span>))
})</code></pre></div>
<p>Visualisons le premier jeu de données horaires du premier subset filtré IRM</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">DT<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/DT/topics/datatable">datatable</a></span>(subsets_hourly_without_IRM[[<span class="dv">1</span>]][[<span class="dv">1</span>]])</code></pre></div>
<div id="htmlwidget-4d01567f65fb474a018f" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-4d01567f65fb474a018f">{"x":{"filter":"none","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28"],["2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z","2017-07-15T23:00:00Z"],[33,10,40,24,36,4,13,32,25,23,38,34,14,19,15,61,17,42,26,1,18,9,39,29,7,35,27,37],[17,13.7,14.6,14.7,null,15.4,14.6,15.6,12.6,13.2,16.5,14.9,15.5,16.5,16.3,14.9,15.4,16.2,15.7,14.2,15.1,13.8,15.1,15.8,15,15,15.2,14.8],[729689.186232954,734687.929509015,658415.101041165,756742.822500184,627307.661070376,714221.209144658,641664.774797854,705538.981444004,783160.145063778,772236.165811055,574629.058020142,640641.2284459,737727.264778507,678027.226189239,683923.206578923,713314.373606281,712454.191609501,751432.178937187,687345.744040475,721240.184391761,669292.934672129,753130.611776411,679485.472308161,737505.849377553,750500.668626812,722969.231282202,666459.252552218,647940.949348427],[653082.367312686,580969.576613894,641458.222311023,616701.10045012,636375.292340349,543453.775467364,588814.572323289,635009.757849171,627630.802845596,611877.550607324,641464.793156667,636931.490722412,621625.053035861,626899.296759005,609727.175874467,598442.549766796,595357.711935966,635301.52304187,638365.311350664,568849.614202561,650971.028015921,581716.936230862,656365.759641032,525914.293584876,550825.572519077,628081.869385831,635438.329307189,609042.529115887],[160.30742628053,390.309470906876,123.673744485628,415.850883728445,95.4065320929548,343.262113452198,259.474801238954,170.11553676668,623.602330192649,538.472515251095,49.0728353792276,117.126398205931,238.256344351755,93.708054231619,219.974695428517,289.133356310043,243.037079128113,286.311629102436,173.655601233621,474.945369085699,133.827267005294,496.688240385978,138.220813581026,317.319254249168,348.391795103584,273.799691609328,147.213489415358,156.315703056096]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>mtime<\/th>\n      <th>sid<\/th>\n      <th>tsa<\/th>\n      <th>x<\/th>\n      <th>y<\/th>\n      <th>elevation<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[2,3,4,5,6]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script><div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># in your console, you can use :</span>
<span class="co"># subsets_hourly_without_IRM[[1]][[1]]</span></code></pre></div>
<p>le filtre a bel et bien fonctionné, nous n’avons plus de stations avec des sid’s au-delà de 1000.</p>
</div>
<div id="conclusion-concernant-la-creation-de-jeux-de-donnees" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion-concernant-la-creation-de-jeux-de-donnees" class="anchor"></a>Conclusion concernant la création de jeux de données</h2>
<p>Nous disposons maintenant de deux jeux de 5 subsets tirés aléatoirement et contenant chacun 0.1 % des data originales (un Pameseb only et un Pameseb + IRM). Nous pouvons maintenant convertir chacun des subsets de ces deux grands ensembles en tâches de machine learning</p>
</div>
</div>
<div id="taches-de-machine-learning" class="section level1">
<h1 class="hasAnchor">
<a href="#taches-de-machine-learning" class="anchor"></a>Tâches de machine learning</h1>
<div id="creation-des-taches" class="section level2">
<h2 class="hasAnchor">
<a href="#creation-des-taches" class="anchor"></a>Création des tâches</h2>
<p>Pour chacun des 5 subsets de nos deux groupes Pameseb et Pameseb + IRM, nous pouvons créer nos tâches de machine learning.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># creation of the tasks for each of the subsets from Pameseb + IRM</span>
tasks_hourly =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(subsets_hourly, <span class="cf">function</span>(x){ <span class="co"># each x correspond to one of our 5 subsets</span>
  task =<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(makeTask, <span class="dt">target =</span> <span class="st">"tsa"</span>)
})

<span class="co"># creatin of the tasks for each of the subsets from Pameseb</span>
tasks_hourly_without_IRM =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(subsets_hourly_without_IRM, <span class="cf">function</span>(x){ <span class="co"># each x correspond to one of our 5 subsets</span>
  task =<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span>(makeTask, <span class="dt">target =</span> <span class="st">"tsa"</span>)
})

<span class="co"># extract the tasks from the outputs</span>
tasks_hourly_data =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(tasks_hourly, <span class="cf">function</span>(x){ <span class="co"># each x correspond to one of our 5 subsets</span>
  x =<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/modify.html">modify_depth</a></span>(<span class="dv">1</span>, <span class="op">~</span>.<span class="op">$</span>output<span class="op">$</span>value<span class="op">$</span>task)
}) 

<span class="co"># extract the tasks from the outputs</span>
tasks_hourly_without_IRM_data =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(tasks_hourly_without_IRM, <span class="cf">function</span>(x){ <span class="co"># each x correspond to one of our 5 subsets</span>
  x =<span class="st"> </span>x <span class="op">%&gt;%</span><span class="st"> </span>purrr<span class="op">::</span><span class="kw"><a href="https://purrr.tidyverse.org/reference/modify.html">modify_depth</a></span>(<span class="dv">1</span>, <span class="op">~</span>.<span class="op">$</span>output<span class="op">$</span>value<span class="op">$</span>task)
}) </code></pre></div>
<p>Visualisons la première tâche du premier de nos subsets :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tasks_hourly_data[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</code></pre></div>
<pre><code>## Supervised task: 20170716010000
## Type: regr
## Target: tsa
## Observations: 43
## Features:
##    numerics     factors     ordered functionals 
##           3           0           0           0 
## Missings: FALSE
## Has weights: FALSE
## Has blocking: FALSE
## Has coordinates: FALSE</code></pre>
<p>Et la même tâche excluant les data IRM :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tasks_hourly_without_IRM_data[[<span class="dv">1</span>]][[<span class="dv">1</span>]]</code></pre></div>
<pre><code>## Supervised task: 20170716010000
## Type: regr
## Target: tsa
## Observations: 27
## Features:
##    numerics     factors     ordered functionals 
##           3           0           0           0 
## Missings: FALSE
## Has weights: FALSE
## Has blocking: FALSE
## Has coordinates: FALSE</code></pre>
<p>Nous voyons qu’en ayant passer un filter supprimant les data des stations IRM, nous passons de 43 à 27 observations.</p>
</div>
<div id="recuperation-des-metadata-concernant-la-creation-de-taches" class="section level2">
<h2 class="hasAnchor">
<a href="#recuperation-des-metadata-concernant-la-creation-de-taches" class="anchor"></a>Récupération des metadata concernant la création de tâches</h2>
<p>La fonction <code>agrometeor::makeTask()</code> supprime automatiquement les observations pour lesquelles il y a une donnée manquante. A noter que c’est le backend de JP qui détermine les données manquantes (ex : TSa state qui n’est pas égal à 1).</p>
<p>Voici la liste des stations retenues pour la première tâche du premier subset pour le jeu de données Pameseb + IRM :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tasks_hourly[[<span class="dv">1</span>]][[<span class="dv">1</span>]]<span class="op">$</span>output<span class="op">$</span>stations<span class="op">$</span>used</code></pre></div>
<pre><code>##  [1]   33   10   40   24    4   13   32   25   23   38   34   14   19   15
## [15]   61   17   42   26    1   18    9   39   29    7   35   27   37 1009
## [29] 1003 1012 1002 1004 1011 1007 1015 1001 1008 1006 1000 1014 1010 1013
## [43] 1005</code></pre>
<p>Et la même information pour le jeu de données excluant les stations IRM:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tasks_hourly_without_IRM[[<span class="dv">1</span>]][[<span class="dv">1</span>]]<span class="op">$</span>output<span class="op">$</span>stations<span class="op">$</span>used</code></pre></div>
<pre><code>##  [1] 33 10 40 24  4 13 32 25 23 38 34 14 19 15 61 17 42 26  1 18  9 39 29
## [24]  7 35 27 37</code></pre>
</div>
</div>
<div id="implementation-des-learners" class="section level1">
<h1 class="hasAnchor">
<a href="#implementation-des-learners" class="anchor"></a>Implémentation des learners</h1>
<p>Plusieurs learners viennent précompilés avec le package agrometeoR. Ceux-ci sont compilés dans le fichier <code>./data-raw.makeLearner.R</code> du package.</p>
<p>Voici les learners implémentés :</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/data">data</a></span>(agrometeorLearners)
learners =<span class="st"> </span>agrometeorLearners</code></pre></div>
</div>
<div id="execution-du-benchmark" class="section level1">
<h1 class="hasAnchor">
<a href="#execution-du-benchmark" class="anchor"></a>Exécution du benchmark</h1>
<div id="demarches-prealables" class="section level2">
<h2 class="hasAnchor">
<a href="#demarches-prealables" class="anchor"></a>Démarches préalables</h2>
<p>Une fois que les tâches ont été créées, nous les sauvegardons sur disque, afin de pouvoir les ré-utiliser autant de fois que désiré sans avoir à les recompiler. Dans le contexte de notre exempe, nous nous limiterons seulement au benchmark des tâches contenant les data Pameseb + IRM stockées dans l’objet <code>tasks_hourly_data</code>. Voici le code à utiliser pour sauvegarder l’objet de tâches sur disque au niveau du folder <code>./outputs/tasks/</code> dans le fichier <code>tasks_hourly_data.rds</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">saveRDS</a></span>(
  <span class="dt">object =</span> tasks_hourly_data,
  <span class="dt">file =</span> <span class="st">"./outputs/tasks/tasks_hourly_data.rds"</span>)</code></pre></div>
<p>Pour réaliser le benchmark, il est <a href="https://stackoverflow.com/questions/15668893/r-multicore-mcfork-unable-to-fork-cannot-allocate-memory">préférable</a> de travailler depuis un terminal.</p>
<p>La stratégie est la suivante. Il s’agit de créer un petit script R <a href="https://github.com/IARCbioinfo/R-tricks#use-rscript-to-run-r-from-bash">exécutable depuis le terminal</a> (+ d’info par <a href="http://www.milanor.net/blog/bashr-howto-pass-parameters-from-bash-script-to-r/">ici</a>) qui va charger les fichiers <code>.rds</code> contenant les tâches et s’en servir pour créer le benchmark.</p>
<p>Ce script sera appelé depuis une session bash ouverte sur le serveur de calcul et lancée depuis une session tmux (afin d’éviter toute interruption du calcul en cas de coupure réseau par exemple).</p>
<p>Ci-dessous nous est présenté le script R exécutable depuis bash et permettant de réaliser un benchmark. Il nous suffit de le copier et de l’enregistrer dans notre working directory. Dans cet exemple nous l’appellerons <code>execute_bmr_from_bash.R</code></p>
<p>Le script prend 4 paramètres. Dans l’ordre : * Le chemin relatif aui wd du fichier contenant les tâches à soumettre : <code>./outputs/tasks/tasks_hourly_data.rds</code> * le nom que l’on souhaite donner au fichier d’output du benchmark : <code>bmr_hourly_from_terminal</code> (le point rds est ajouté automatiquement par le script ci-dessous) * le chemin du dossier dans lequel l’on souhaite sauvegarder l’output final du benchmark. <code>./outputs/bmr/</code> (le dossier doit exister !) * le chemin du dossier dans lequel l’on souhaite sauvegarder les fichiers temporaires. <code>./outputs/tempfiles/</code> (le dossier doit exister !)</p>
<p>A noter que la fonction <code><a href="https://www.rdocumentation.org/packages/agrometeoR/topics/makeBmrsBatch">agrometeoR::makeBmrsBatch()</a></code> exige pour le moment que le folder dans lequel l’on souhaite enregistrer les fichiers temporaires de benchmark existe. i lfaut donc préalablement le créer.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#!/usr/bin/env Rscript</span>

<span class="co"># Rscript ./script_execute_bmr.R ./data-created/tasksdataPamesebIrmDailyForBmrs.rds daily_tsa_PamesebIrm</span>

<span class="co"># parsing the 4 args that must be passed to bash CLI. These args are then passed to our benchmarking function. </span>
args =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/commandArgs">commandArgs</a></span>(<span class="dt">trailingOnly =</span> <span class="ot">TRUE</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"The current working directory is "</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/getwd">getwd</a></span>()))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"The demanded task file is "</span>, args[<span class="dv">1</span>])
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"Your output file will be prefixed by : "</span>, args[<span class="dv">2</span>])
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"Your output file will be stored into : "</span>, args[<span class="dv">3</span>])
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"Your temporary files will be stored into : "</span>, args[<span class="dv">4</span>])

<span class="co"># storing the 4 bash command arguments in variables</span>
tasks.file =<span class="st"> </span>args[<span class="dv">1</span>]
output.name =<span class="st"> </span>args[<span class="dv">2</span>]
output.folder =<span class="st"> </span>args[<span class="dv">3</span>]
output.tempdir =<span class="st"> </span>args[<span class="dv">4</span>]

<span class="co"># test if the task file exist else return an error</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/stopifnot">stopifnot</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(tasks.file)))

<span class="co"># load the required libraries to perform the benchmark</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"loading the required libs"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">suppressMessages</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(parallelMap))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">suppressMessages</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(mlr))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">suppressMessages</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(agrometeoR))
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">suppressMessages</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr))

<span class="co"># load the data for the bmrs</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"Reading and loading the tasks file"</span>, tasks.file))
tasks =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">readRDS</a></span>(tasks.file)

<span class="co"># perform the benchmarks</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"Starting to conduct the benchmarks..."</span>)
bmrsResult =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/agrometeoR/topics/makeBmrsBatch">makeBmrsBatch</a></span>(
  <span class="dt">tasks =</span> tasks,
  <span class="dt">learners =</span> agrometeorLearners,
  <span class="dt">measures =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(mlr<span class="op">::</span>rmse, mlr<span class="op">::</span>mae, mlr<span class="op">::</span>mse),
  <span class="dt">keep.pred =</span> <span class="ot">TRUE</span>,
  <span class="dt">models =</span> <span class="ot">FALSE</span>,
  <span class="dt">groupSize =</span> <span class="dv">100</span>,
  <span class="dt">level =</span> <span class="st">"mlr.benchmark"</span>,
  <span class="dt">resamplings =</span> <span class="st">"LOO"</span>,
  <span class="dt">cpus =</span> <span class="dv">8</span>,
  <span class="dt">prefix =</span> output.name,
  <span class="dt">temp_dir =</span> output.tempdir,
  <span class="dt">removeTemp =</span> <span class="ot">FALSE</span>
)

<span class="co"># save the bmrs result</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/message">message</a></span>(<span class="st">"Saving the result..."</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readRDS">saveRDS</a></span>(
  <span class="dt">object =</span> bmrsResult,
  <span class="dt">file =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(
   output.folder,<span class="co"># "./data-created/",</span>
    output.name,
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">as.character</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.Date</a></span>()),
    <span class="st">"_bmrsResult.rds"</span>))

<span class="co"># purge the memory</span>
<span class="co"># rm(list = ls())</span></code></pre></div>
</div>
<div id="connexion-au-serveur-via-tmux" class="section level2">
<h2 class="hasAnchor">
<a href="#connexion-au-serveur-via-tmux" class="anchor"></a>Connexion au serveur via tmux</h2>
<p>Pour utiliser ce script depuis le terminal : lançons bash, connectons-nous en ssh au serveur de calcul (il nous faut une clef SSH évidemment) et démarrons une session tmux :</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="fu">ssh</span> agromet
<span class="ex">tmux</span> ls <span class="co">#list</span>

<span class="ex">tmux</span> new-session -s bmr

<span class="bu">cd</span> Rprojects/currentProject/

<span class="ex">tmux</span> attach

<span class="fu">chmod</span> +x execute_bmr_from_bash.R <span class="co"># make the script exécutable</span>

<span class="ex">./execute_bmr_from_bash.R</span> ./outputs/tasks/tasks_hourly_data.rds bmr_hourly_from_terminal ./outputs/bmr/ ./outputs/tempfiles <span class="co"># execution du bmr en terminal/</span>

<span class="co"># type ctrl+b et puis d =&gt; hide the plex</span>

<span class="co"># tmux attach to see it again</span>

<span class="co"># type exit to kill a plex</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#objectif">Objectif</a></li>
      <li><a href="#initialisation-du-projet">Initialisation du projet</a></li>
      <li>
<a href="#creation-des-jeux-de-donnnees-">Création des jeux de donnnées.</a><ul class="nav nav-pills nav-stacked">
<li><a href="#charger-lextract-hourly-de-la-database">Charger l’extract hourly de la database</a></li>
      <li><a href="#creation-du-jeu-de-donnees-daily">Création du jeu de données daily</a></li>
      <li><a href="#creation-des-sous-echantillons-aleatoires-">Création des sous-échantillons aléatoires.</a></li>
      <li><a href="#creation-de-doublons-ne-contenant-que-les-data-pameseb">Création de doublons ne contenant que les data Pameseb</a></li>
      <li><a href="#conclusion-concernant-la-creation-de-jeux-de-donnees">Conclusion concernant la création de jeux de données</a></li>
      </ul>
</li>
      <li>
<a href="#taches-de-machine-learning">Tâches de machine learning</a><ul class="nav nav-pills nav-stacked">
<li><a href="#creation-des-taches">Création des tâches</a></li>
      <li><a href="#recuperation-des-metadata-concernant-la-creation-de-taches">Récupération des metadata concernant la création de tâches</a></li>
      </ul>
</li>
      <li><a href="#implementation-des-learners">Implémentation des learners</a></li>
      <li>
<a href="#execution-du-benchmark">Exécution du benchmark</a><ul class="nav nav-pills nav-stacked">
<li><a href="#demarches-prealables">Démarches préalables</a></li>
      <li><a href="#connexion-au-serveur-via-tmux">Connexion au serveur via tmux</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Thomas Goossens.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
