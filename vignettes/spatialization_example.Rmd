---
title: "A simple spatialization example using agrometeoR"
author: "Thomas Goossens"
date: "11/22/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
devtools::load_all()
```

## Load the libraries

```{r libraries}
# loading mlr & agrometeoR
library(mlr)
library(agrometeoR)
```


## Create the machine learning task for a specific hour
*Check the default values of the params in the references file to make sure you understand what is constructed* 
```{r task}
# create the task
myTasks = makeTasks(dataset = (makeDataset(dfrom = "2017-03-04T15:00:00Z", dto = "2017-03-04T15:00:00Z", sensor = "tsa"))$output, target = "tsa")
# what are the variables ? 
colnames(mlr::getTaskData(myTasks$output$`20170304150000`))
# what data do we have ? 
head(getTaskData(myTasks$output$`20170304150000`))
```

## Train a learner

```{r train, message=FALSE, warning=FALSE, paged.print=TRUE}
# instantiate a multiple li,near regression learner and specify that it must also provide se of preds
myLearner = mlr::makeLearner("regr.lm", id = "multipleLinearReg", predict.type = "se" )
# create the model by training the learner and also benchmark the learner with a LOO
myModel = makeModel(task = myTasks$output$`20170304150000`, learner = myLearner)
# what are the model performances ? 
myModel$output$perfs$agg
# what about the residuals ? 
plot(x =  getTaskData(myTasks$output$`20170304150000`)[["tsa"]], myModel$output$residuals[[1]])
```

## Spatialize using the trained a learner

```{r spatializeconfig, include=FALSE}
# trick to avoir overwriting error with st_write - https://github.com/r-spatial/sf/issues/274
files = list.files()
if (!is.null(paste0(myTasks$output$`20170304150000`$task.desc$id, ".geojson" %in% files))) {
  file.remove(paste0(myTasks$output$`20170304150000`$task.desc$id, ".geojson"))
}
```

```{r spatialize, message=FALSE, warning=FALSE}
# produce the spatialized geojson
spatialized = makeSpatialization(model = myModel$output$trained)
# read it
head(spatialized)
```

## Map the results
```{r}
# make it a spatial object
spatialized.sf = sf::st_as_sf(spatialized$output, coords = c("X","Y"))
# map it ! 
plot(spatialized.sf)
```

